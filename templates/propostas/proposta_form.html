{% extends 'base.html' %}
{% load static %}
{% load errors_filters %} 

{% block content %}
  
<div>

  <form method="post" id="propostaForm" enctype="multipart/form-data" class="needs-validation">
    {% csrf_token %}

    <!-- DADOS DA PROPOSTA -->
    <div class="card formulario-card mb-4">
      <div class="card-header">
        <i class="fas fa-clipboard-list me-2"></i> Dados da Proposta
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3 form-floating">
            {{ proposta_form.nr_proposta }}
            <label for="{{ proposta_form.nr_proposta.id_for_label }}">
              {{ proposta_form.nr_proposta.label }}
            </label>
          </div>
          <div class="col-md-2 form-floating">
            {{ proposta_form.vl_financiado }}
            <label for="{{ proposta_form.vl_financiado.id_for_label }}">
              {{ proposta_form.vl_financiado.label }}
            </label>
          </div>
          <div class="col-md-2 form-floating">
            {{ proposta_form.prazo }}
            <label for="{{ proposta_form.prazo.id_for_label }}">
              {{ proposta_form.prazo.label }}
            </label>
          </div>
          <div class="col-md-2 form-floating">
            {{ proposta_form.vl_parcela }}
            <label for="{{ proposta_form.vl_parcela.id_for_label }}">
              {{ proposta_form.vl_parcela.label }}
            </label>
          </div>
          <div class="col-md-3 form-floating">
            {{ proposta_form.dt_proposta }}
            <label for="{{ proposta_form.dt_proposta.id_for_label }}">
              {{ proposta_form.dt_proposta.label }}
            </label>
          </div>
        </div>

        <div class="row g-3 mt-3">
          <div class="col-md-4 form-floating">
            {{ proposta_form.operador }}
            <label for="{{ proposta_form.operador.id_for_label }}">
              {{ proposta_form.operador.label }}
            </label>
          </div>
          <div class="col-md-4 form-floating">
            <select id="id_loja" class="form-select" name="loja">
              <option value="">Selecione uma loja...</option>
            </select>
            <label for="id_loja">Loja</label>
          </div>
          <div class="col-md-2 form-floating">
            <select id="id_vendedor" class="form-select" name="vendedor">
                <option value="">Selecione um vendedor...</option>
            </select>
            <label for="id_vendedor">Vendedor</label>
          </div>
          <div class="col-md-2 d-flex align-items-center">
            <button type="button"
                    class="btn btn-outline-primary rounded-circle d-flex align-items-center justify-content-center"
                    data-bs-toggle="modal" data-bs-target="#modalNovoVendedor"
                    style="width: 25px; height: 25px;">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>

        <div class="row g-3 mt-3">
          <div class="col-md-2 form-floating">
            {{ proposta_form.financeira }}
            <label for="{{ proposta_form.financeira.id_for_label }}">
              {{ proposta_form.financeira.label }}
            </label>
          </div>
          <div class="col-md-2 form-floating">
            {{ proposta_form.modalidade }}
            <label for="{{ proposta_form.modalidade.id_for_label }}">
              {{ proposta_form.modalidade.label }}
            </label>
          </div>
          <div class="col-md-2 form-floating">
            {{ proposta_form.segmento }}
            <label for="{{ proposta_form.segmento.id_for_label }}">
              {{ proposta_form.segmento.label }}
            </label>
          </div>
          <div class="col-md-2 form-floating">
            <select id="id_produto" class="form-select" name="produto">
              <option value="">Selecione um produto...</option>
            </select>
            <label for="id_produto">Produto</label>
          </div>
          <div class="col-md-2 form-floating">
            {{ proposta_form.status }}
            <label for="{{ proposta_form.status.id_for_label }}">
              {{ proposta_form.status.label }}
            </label>
          </div>
          <div class="col-md-2 form-floating">
            {{ proposta_form.dt_pagamento }}
            <label for="{{ proposta_form.dt_pagamento.id_for_label }}">
              {{ proposta_form.dt_pagamento.label }}
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- DADOS DO VEÍCULO -->
    <div class="card formulario-card mb-4">
      <div class="card-header">
        <i class="fas fa-car me-2"></i> Dados do Veículo
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3 form-floating">
            {{ veiculo_form.marca }}
            <label for="{{ veiculo_form.marca.id_for_label }}">
              {{ veiculo_form.marca.label }}
            </label>
          </div>
          <div class="col-md-3 form-floating">
            {{ veiculo_form.modelo }}
            <label for="{{ veiculo_form.modelo.id_for_label }}">
              {{ veiculo_form.modelo.label }}
            </label>
          </div>
          <div class="col-md-2 form-floating">
            {{ veiculo_form.ano_fabricacao }}
            <label for="{{ veiculo_form.ano_fabricacao.id_for_label }}">
              {{ veiculo_form.ano_fabricacao.label }}
            </label>
          </div>
          <div class="col-md-2 form-floating">
            {{ veiculo_form.ano_modelo }}
            <label for="{{ veiculo_form.ano_modelo.id_for_label }}">
              {{ veiculo_form.ano_modelo.label }}
            </label>
          </div>
          <div class="col-md-2 form-floating">
            {{ veiculo_form.vl_veiculo }}
            <label for="{{ veiculo_form.vl_veiculo.id_for_label }}">
              {{ veiculo_form.vl_veiculo.label }}
            </label>
          </div>
        </div>
        <div class="row g-3 mt-3">
          <div class="col-md-2 form-floating">
            {{ veiculo_form.placa }}
            <label for="{{ veiculo_form.placa.id_for_label }}">
              {{ veiculo_form.placa.label }}
            </label>
          </div>
          <div class="col-md-2 form-floating">
            {{ veiculo_form.renavam }}
            <label for="{{ veiculo_form.renavam.id_for_label }}">
              {{ veiculo_form.renavam.label }}
            </label>
          </div>
          <div class="col-md-3 form-floating">
            {{ veiculo_form.chassi }}
            <label for="{{ veiculo_form.chassi.id_for_label }}">
              {{ veiculo_form.chassi.label }}
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- DADOS DO CLIENTE -->
    <div class="card formulario-card mb-4">
      <div class="card-header">
        <i class="fas fa-user me-2"></i> Dados do Cliente
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3 form-floating">
            {{ cliente_form.nr_cpf }}
            <label for="{{ cliente_form.nr_cpf.id_for_label }}">
              {{ cliente_form.nr_cpf.label }}
            </label>
          </div>
          <div class="col-md-3 form-floating">
            {{ cliente_form.nm_cliente }}
            <label for="{{ cliente_form.nm_cliente.id_for_label }}">
              {{ cliente_form.nm_cliente.label }}
            </label>
          </div>
          <div class="col-md-3 form-floating">
            {{ cliente_form.dt_nascimento }}
            <label for="{{ cliente_form.dt_nascimento.id_for_label }}">
              {{ cliente_form.dt_nascimento.label }}
            </label>
          </div>
          <div class="col-md-3 form-floating">
            {{ cliente_form.sexo }}
            <label for="{{ cliente_form.sexo.id_for_label }}">
              {{ cliente_form.sexo.label }}
            </label>
          </div>
        </div>
        <div class="row g-3 mt-3">
          <div class="col-md-3 form-floating">
            {{ cliente_form.rg_cliente }}
            <label for="{{ cliente_form.rg_cliente.id_for_label }}">
              {{ cliente_form.rg_cliente.label }}
            </label>
          </div>
          <div class="col-md-3 form-floating">
            {{ cliente_form.nm_mae }}
            <label for="{{ cliente_form.nm_mae.id_for_label }}">
              {{ cliente_form.nm_mae.label }}
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- ENDEREÇO (Form Único) -->
    <div class="card formulario-card mb-4">
      <div class="card-header">
        <i class="fas fa-home me-2"></i> Endereço
      </div>
      <div class="card-body">
        {{ endereco_form.id }} <!-- campo hidden para id, se houver -->
        <div class="row g-3">
          <div class="col-md-2 form-floating">
            {{ endereco_form.cep }}
            <label for="{{ endereco_form.cep.id_for_label }}">{{ endereco_form.cep.label }}</label>
          </div>
          <div class="col-md-4 form-floating">
            {{ endereco_form.endereco }}
            <label for="{{ endereco_form.endereco.id_for_label }}">{{ endereco_form.endereco.label }}</label>
          </div>
          <div class="col-md-2 form-floating">
            {{ endereco_form.nro }}
            <label for="{{ endereco_form.nro.id_for_label }}">{{ endereco_form.nro.label }}</label>
          </div>
          <div class="col-md-4 form-floating">
            {{ endereco_form.complemento }}
            <label for="{{ endereco_form.complemento.id_for_label }}">{{ endereco_form.complemento.label }}</label>
          </div>
        </div>
        <div class="row g-3 mt-2">
          <div class="col-md-2 form-floating">
            {{ endereco_form.bairro }}
            <label for="{{ endereco_form.bairro.id_for_label }}">{{ endereco_form.bairro.label }}</label>
          </div>
          <div class="col-md-2 form-floating">
            {{ endereco_form.cidade }}
            <label for="{{ endereco_form.cidade.id_for_label }}">{{ endereco_form.cidade.label }}</label>
          </div>
          <div class="col-md-1 form-floating">
            {{ endereco_form.uf }}
            <label for="{{ endereco_form.uf.id_for_label }}">{{ endereco_form.uf.label }}</label>
          </div>
        </div>
      </div>
    </div>

    <!-- CONTATO (Form Único) -->
    <div class="card formulario-card mb-4">
      <div class="card-header">
        <i class="fas fa-phone me-2"></i> Contatos
      </div>
      <div class="card-body">
        {{ contato_form.id }}
        <div class="row g-3">
          <div class="col-md-4 form-floating">
            {{ contato_form.telefone_fixo }}
            <label for="{{ contato_form.telefone_fixo.id_for_label }}">{{ contato_form.telefone_fixo.label }}</label>
          </div>
          <div class="col-md-4 form-floating">
            {{ contato_form.celular }}
            <label for="{{ contato_form.celular.id_for_label }}">{{ contato_form.celular.label }}</label>
          </div>
          <div class="col-md-4 form-floating">
            {{ contato_form.email }}
            <label for="{{ contato_form.email.id_for_label }}">{{ contato_form.email.label }}</label>
          </div>
        </div>
      </div>
    </div>

    <!-- PROFISSÃO (Form Único) -->
    <div class="card formulario-card mb-4">
      <div class="card-header">
        <i class="fas fa-briefcase me-2"></i> Dados Comerciais
      </div>
      <div class="card-body">
        {{ profissao_form.id }}
        <div class="row g-3">
          <div class="col-md-2 form-floating">
            {{ profissao_form.profissao }}
            <label for="{{ profissao_form.profissao.id_for_label }}">
              {{ profissao_form.profissao.label }}
            </label>
          </div>
          <div class="col-md-2 form-floating">
            {{ profissao_form.cargo }}
            <label for="{{ profissao_form.cargo.id_for_label }}">
              {{ profissao_form.cargo.label }}
            </label>
          </div>
          <div class="col-md-3 form-floating">
            {{ profissao_form.local_trabalho }}
            <label for="{{ profissao_form.local_trabalho.id_for_label }}">
              {{ profissao_form.local_trabalho.label }}
            </label>
          </div>
          <div class="col-md-2 form-floating">
            {{ profissao_form.data_admissao }}
            <label for="{{ profissao_form.data_admissao.id_for_label }}">
              {{ profissao_form.data_admissao.label }}
            </label>
          </div>
          <div class="col-md-2 form-floating">
            {{ profissao_form.renda }}
            <label for="{{ profissao_form.renda.id_for_label }}">
              {{ profissao_form.renda.label }}
            </label>
          </div>
          <div class="col-md-2 form-floating">
            {{ profissao_form.outras_rendas }}
            <label for="{{ profissao_form.outras_rendas.id_for_label }}">
              {{ profissao_form.outras_rendas.label }}
            </label>
          </div>
          <div class="col-md-3 form-floating mt-3">
            {{ profissao_form.fone_lt }}
            <label for="{{ profissao_form.fone_lt.id_for_label }}">
              {{ profissao_form.fone_lt.label }}
            </label>
          </div>
        </div>
      </div>
    </div>

<!-- BOTÕES DE AÇÃO -->
<div class="d-flex justify-content-between my-4">
  <!-- Botão Voltar -->
  <button>
      <a href="{% url 'propostas:listar_propostas' %}" id="btn">
          <div class="btn-negative-half">
              <i class="fas fa-arrow-left me-1"></i> Voltar
          </div>
      </a>
  </button>

  <!-- Botão Salvar -->
  <button type="submit" id="btn">
      <div class="btn-positive-half">
          <i class="fas fa-save me-1"></i> Salvar Proposta
      </div>
  </button>
</div>

  </form>

<!-- Modal Novo Vendedor -->
<div class="modal fade" id="modalNovoVendedor" tabindex="-1" aria-labelledby="modalNovoVendedorLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="modalNovoVendedorLabel">Cadastrar Novo Vendedor</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
              <form id="formNovoVendedor">
                  {% csrf_token %}
                  <div class="mb-3">
                      <label for="novo_vendedor_nome" class="form-label">Nome do Vendedor</label>
                      <input type="text" class="form-control" id="novo_vendedor_nome" name="nome_vendedor" required>
                  </div>
                  <div class="mb-3">
                      <label for="novo_vendedor_cpf" class="form-label">CPF</label>
                      <input type="text" class="form-control" id="novo_vendedor_cpf" name="cpf_vendedor" required>
                  </div>
                  <div class="mb-3">
                      <label for="novo_vendedor_celular" class="form-label">Celular</label>
                      <input type="text" class="form-control" id="novo_vendedor_celular" name="celular_vendedor" required>
                  </div>
                  <div class="mb-3">
                      <label for="novo_vendedor_email" class="form-label">E-mail</label>
                      <input type="email" class="form-control" id="novo_vendedor_email" name="email_vendedor">
                  </div>
                  <div class="mb-3">
                      <label for="novo_vendedor_pix" class="form-label">Chave PIX</label>
                      <input type="text" class="form-control" id="novo_vendedor_pix" name="chave_pix">
                  </div>
                  <button type="submit" class="btn btn-success">Salvar</button>
              </form>
          </div>
      </div>
  </div>
</div>


<!-- ERROS DOS FORMSETS -->
{% for formset in formsets %}
  {% if formset.non_form_errors %}
    <div class="alert alert-danger">
      <strong>Erros gerais no formset {{ formset.prefix }}:</strong>
      <ul>
        {% for error in formset.non_form_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
  {% for form in formset.forms %}
    {% if form.errors %}
      <div class="alert alert-danger">
        <strong>Erros no formulário {{ form.prefix }} do formset {{ formset.prefix }}:</strong>
        <ul>
          {% for field, errors in form.errors.items %}
            {% if field == '__all__' %}
              {% for error in errors %}
                <li>{{ error }}</li>
              {% endfor %}
            {% else %}
              {% with field_obj=form|get_item:field %}
                <li><strong>{{ field_obj.label }}:</strong> {{ errors|join:", " }}</li>
              {% endwith %}
            {% endif %}
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  {% endfor %}
{% endfor %}


<!--</div>-->



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<script>
  $(document).ready(function() {
    console.log('Página carregada.');

    // ========================================================================
    // FUNÇÃO PARA APLICAR MÁSCARAS
    // ========================================================================
    function aplicarMascaras() {
      // Máscara para valores monetários
      $('input[id*="vl_financiado"], input[id*="vl_parcela"], input[id*="renda"], input[id*="vl_veiculo"], input[id*="outras_rendas"]').mask('000.000.000.000,00', { reverse: true });
      
      // Máscara para CEP
      $('input[id*="cep"]').mask('00000-000');
      
      // Máscara para telefones
      $('input[id*="telefone_fixo"]').mask('(00) 0000-0000');
      $('input[id*="celular"]').mask('(00) 00000-0000');
      
      // Máscara para CPF
      $('input[id*="nr_cpf"]').mask('000.000.000-00', { reverse: true });
    }

    // ========================================================================
    // HABILITAR/DESABILITAR DATA DE PAGAMENTO CONFORME STATUS
    // ========================================================================
    function verificarStatusPagamento() {
      let statusField = $("#{{ proposta_form.status.id_for_label }}");
      let dataPagamentoField = $("#{{ proposta_form.dt_pagamento.id_for_label }}");


      function atualizarCampoPagamento() {
        let statusTexto = statusField.find("option:selected").text().trim();
        if (statusTexto === "Paga") {
          dataPagamentoField.removeAttr("disabled");
        } else {
          dataPagamentoField.attr("disabled", "true");
          dataPagamentoField.val("");
        }
      }

      // Executa a verificação ao carregar a página
      atualizarCampoPagamento();
      // Adiciona listener para mudanças no status
      statusField.on('change', atualizarCampoPagamento);
    }

    // ========================================================================
    // REAPLICAR MÁSCARAS DINAMICAMENTE
    // ========================================================================
    $(document).on('click', '.add-row', function () {
      setTimeout(aplicarMascaras, 100); // Pequeno delay para garantir a renderização
    });

    // ========================================================================
    // REMOVER FORMATOS ANTES DE ENVIAR O FORMULÁRIO
    // ========================================================================
    $('#propostaForm').on('submit', function () {
      // Remover formatação dos campos monetários
      $('input[id*="vl_financiado"], input[id*="vl_parcela"], input[id*="renda"], input[id*="vl_veiculo"], input[id*="outras_rendas"]').each(function () {
        let valor = $(this).val();
        let valorNumerico = valor.replace(/\./g, '').replace(',', '.');
        $(this).val(valorNumerico);
      });
      // Remover caracteres não numéricos de telefones, CEP e CPF
      $('input[id*="telefone_fixo"], input[id*="celular"], input[id*="cep"], input[id*="nr_cpf"]').each(function () {
        $(this).val($(this).val().replace(/\D/g, ''));
      });
    });

    // =========================================================================
    // VARIÁVEIS (TANTO P/ NOVO QUANTO PARA EDIÇÃO)
    // =========================================================================
    const operadorId   = "{{ operador_id|default:'' }}";
    const lojaId       = "{{ loja_id|default:'' }}";
    const vendedorId   = "{{ vendedor_id|default:'' }}";
    const financeiraId = "{{ financeira_id|default:'' }}";
    const modalidadeId = "{{ modalidade_id|default:'' }}";
    const segmentoId   = "{{ segmento_id|default:'' }}";
    const produtoId    = "{{ produto_id|default:'' }}";

    // =========================================================================
    // FUNÇÕES AUXILIARES DE BUSCA (fetch)
    // =========================================================================
    function fetchLojasPorOperador(operador) {
      return fetch(`/propostas/api/lojas/?operador_id=${operador}`).then(resp => resp.json());
    }
    function fetchVendedoresPorLoja(loja) {
      return fetch(`/propostas/api/vendedores_por_loja/?loja_id=${loja}`).then(resp => resp.json());
    }
    function fetchModalidades(financeira) {
      return fetch(`/propostas/api/financeira/modalidades/?financeira_id=${financeira}`).then(resp => resp.json());
    }
    function fetchSegmentos(financeira, modalidade) {
      return fetch(`/propostas/api/financeira/segmentos/?financeira_id=${financeira}&modalidade_id=${modalidade}`)
        .then(resp => resp.json());
    }
    function fetchProdutos(financeira, modalidade, segmento) {
      return fetch(`/propostas/api/financeira/produtos/?financeira_id=${financeira}&modalidade_id=${modalidade}&segmento_id=${segmento}`)
        .then(resp => resp.json());
    }

    // =========================================================================
    // CONSULTA DE CEP / AUTOPREENCHIMENTO
    // =========================================================================
    $(document).on('blur', '[id$="-cep"]', function() {
      const idOriginal = $(this).attr('id');
      console.log(`[CEP] Blur event: ${idOriginal}`);

      const idEndereco = idOriginal.replace('-cep', '-endereco');
      const idBairro   = idOriginal.replace('-cep', '-bairro');
      const idCidade   = idOriginal.replace('-cep', '-cidade');
      const idUf       = idOriginal.replace('-cep', '-uf');

      const cep = $(this).val().replace(/\D/g, '');
      if (cep.length === 8) {
        console.log(`[CEP] Buscando CEP: ${cep}`);
        $.getJSON(`https://viacep.com.br/ws/${cep}/json/`, function(data) {
          if (!data.erro) {
            console.log(`[CEP] CEP ${cep} carregado com sucesso.`);
            $(`#${idEndereco}`).val(data.logradouro || '');
            $(`#${idBairro}`).val(data.bairro || '');
            $(`#${idCidade}`).val(data.localidade || '');
            $(`#${idUf}`).val(data.uf || '');
          } else {
            console.warn(`[CEP] CEP ${cep} não encontrado.`);
            alert('CEP não encontrado.');
          }
        }).fail(function(textStatus, errorThrown) {
          console.error(`[CEP] Erro ao buscar informações do CEP ${cep}:`, textStatus, errorThrown);
          alert('Erro ao buscar informações do CEP.');
        });
      }
    });

    // =========================================================================
    // MÁSCARA & VALIDAÇÃO DE CPF
    // =========================================================================
    $('#id_nr_cpf').on('input', function() {
      let value = $(this).val().replace(/\D/g, '').substring(0, 11);
      if (value.length > 3)  value = value.replace(/(\d{3})(\d)/, '$1.$2');
      if (value.length > 7)  value = value.replace(/(\d{3})(\d)/, '$1.$2');
      if (value.length > 11) value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      $(this).val(value);
    });

    function validarCPF(cpf) {
      cpf = cpf.replace(/[^\d]+/g, "");
      if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
      let soma = 0, resto;
      for (let i = 1; i <= 9; i++) {
        soma += parseInt(cpf.substring(i - 1, i)) * (11 - i);
      }
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.substring(9, 10))) return false;

      soma = 0;
      for (let i = 1; i <= 10; i++) {
        soma += parseInt(cpf.substring(i - 1, i)) * (12 - i);
      }
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      return resto === parseInt(cpf.substring(10, 11));
    }

    $('#id_nr_cpf').on('blur', function() {
      const cpf = $(this).val().replace(/\D/g, '');
      if (!validarCPF(cpf)) {
        alert("CPF inválido. Por favor, digite um CPF válido.");
        return;
      }
      const lojaAtual     = $('#id_loja').val() || '';
      const operadorAtual = $('#id_operador').val() || '';
      console.log(`[CPF] Verificando cliente. CPF: ${cpf}, Loja: ${lojaAtual}, Operador: ${operadorAtual}`);

      $.ajax({
        url: `/propostas/api/verificar-cliente/`,
        data: { cpf: cpf, loja_id: lojaAtual, operador_id: operadorAtual },
        method: "GET",
        success: function(data) {
          if (data.existe) {
            console.log("[CPF] Cliente encontrado. Preenchendo dados...");

            // Preenche dados do cliente
            $("#id_nm_cliente").val(data.nm_cliente || "");
            $("#id_dt_nascimento").val(data.dt_nascimento || "");
            $("#id_rg_cliente").val(data.rg_cliente || "");
            $("#id_nm_mae").val(data.nm_mae || "");
            $("#id_sexo").val(data.sexo || "");

            // Endereço (só 1)
            if (data.enderecos && data.enderecos.length) {
              const e = data.enderecos[0];
              $("#id_endereco-cep").val(e.cep || "");
              $("#id_endereco-endereco").val(e.endereco || "");
              $("#id_endereco-nro").val(e.nro || "");
              $("#id_endereco-complemento").val(e.complemento || "");
              $("#id_endereco-bairro").val(e.bairro || "");
              $("#id_endereco-cidade").val(e.cidade || "");
              $("#id_endereco-uf").val(e.uf || "");
            }

            // Contato (só 1)
            if (data.contatos && data.contatos.length) {
              const c = data.contatos[0];
              $("#id_contato-telefone_fixo").val(c.telefone_fixo || "");
              $("#id_contato-celular").val(c.celular || "");
              $("#id_contato-email").val(c.email || "");
            }

            // Profissão (só 1)
            if (data.profissoes && data.profissoes.length) {
              const p = data.profissoes[0];
              $("#id_profissao-profissao").val(p.profissao || "");
              $("#id_profissao-cargo").val(p.cargo || "");
              $("#id_profissao-local_trabalho").val(p.local_trabalho || "");
              $("#id_profissao-renda").val(p.renda || "");
              $("#id_profissao-outras_rendas").val(p.outras_rendas || "");
              // Se tiver mais campos, preencher aqui...
            }

          } else {
            console.log("[CPF] Cliente não encontrado.");
            alert("Cliente não encontrado. Por favor, cadastre-o.");
          }
        },
        error: function(xhr, status, error) {
          console.error("[CPF] Erro ao buscar cliente:", error);
          alert("Erro ao buscar cliente. Tente novamente mais tarde.");
        },
      });
    });

    // =========================================================================
    // CAMPOS DINÂMICOS (NOVAS PROPOSTAS) - OPERADOR → LOJA → VENDEDOR
    // =========================================================================
    $('#id_operador').on('change', function() {
      const opId = $(this).val();
      // Limpa lojas e vendedores
      $('#id_loja').empty().append('<option value="">Selecione uma loja...</option>');
      $('#id_vendedor').empty().append('<option value="">Selecione um vendedor...</option>');
      if (!opId) return;

      // Carrega Lojas
      fetchLojasPorOperador(opId).then(lojas => {
        lojas.forEach(loja => {
          $('#id_loja').append(`<option value="${loja.id}">${loja.nm_fantasia}</option>`);
        });
      });
    });

    $('#id_loja').on('change', function() {
      const lojaAtual = $(this).val();
      $('#id_vendedor').empty().append('<option value="">Selecione um vendedor...</option>');
      if (!lojaAtual) return;

      // Carrega Vendedores
      fetchVendedoresPorLoja(lojaAtual).then(vendedores => {
        vendedores.forEach(v => {
          $('#id_vendedor').append(`<option value="${v.id}">${v.nome_vendedor}</option>`);
        });
      });
    });

    // =========================================================================
    // CAMPOS DINÂMICOS (NOVAS PROPOSTAS) - FINANCEIRA → MODALIDADE → SEGMENTO
    // =========================================================================
    $('#id_financeira').on('change', function() {
      const fId = $(this).val();
      $('#id_modalidade').empty().append('<option value="">Selecione a Modalidade...</option>');
      $('#id_segmento').empty().append('<option value="">Selecione o Segmento...</option>');
      $('#id_produto').empty().append('<option value="">Selecione o Produto...</option>');
      if (!fId) return;

      fetchModalidades(fId).then(modais => {
        modais.forEach(m => {
          $('#id_modalidade').append(`<option value="${m.id}">${m.nome_modalidade}</option>`);
        });
      });
    });

    $('#id_modalidade').on('change', function() {
      const fId = $('#id_financeira').val();
      const mId = $(this).val();
      $('#id_segmento').empty().append('<option value="">Selecione o Segmento...</option>');
      $('#id_produto').empty().append('<option value="">Selecione o Produto...</option>');
      if (!fId || !mId) return;

      fetchSegmentos(fId, mId).then(segmentos => {
        segmentos.forEach(s => {
          $('#id_segmento').append(`<option value="${s.id}">${s.nome_segmento}</option>`);
        });
      });
    });

    $('#id_segmento').on('change', function() {
      const fId = $('#id_financeira').val();
      const mId = $('#id_modalidade').val();
      const sId = $(this).val();
      $('#id_produto').empty().append('<option value="">Selecione o Produto...</option>');
      if (!fId || !mId || !sId) return;

      fetchProdutos(fId, mId, sId).then(produtos => {
        produtos.forEach(p => {
          $('#id_produto').append(`<option value="${p.id}">${p.nome_produto}</option>`);
        });
      });
    });

    // =========================================================================
    // CARREGAMENTO DE DADOS (PROPOSTAS EXISTENTES) - operador/loja/vendedor
    // =========================================================================
    function carregarOperadorLoja() {
      if (!operadorId) {
        console.log('[Operador/Loja] Sem operadorId (nova proposta ou não definido)');
        return;
      }
      // Seta o operador no select
      $('#id_operador').val(operadorId);

      // Carrega Lojas do operador
      fetchLojasPorOperador(operadorId).then(lojas => {
        const lojaSelect = $('#id_loja')
          .empty()
          .append('<option value="">Selecione uma loja...</option>');
        lojas.forEach(loja => {
          lojaSelect.append(`<option value="${loja.id}">${loja.nm_fantasia}</option>`);
        });

        // Se existir lojaId, seleciona e carrega vendedores
        if (lojaId) {
          $('#id_loja').val(lojaId);
          return fetchVendedoresPorLoja(lojaId);
        }
        return null;
      }).then(vendedores => {
        if (!vendedores) return;
        const vendSelect = $('#id_vendedor')
          .empty()
          .append('<option value="">Selecione um vendedor...</option>');
        vendedores.forEach(v => {
          vendSelect.append(`<option value="${v.id}">${v.nome_vendedor}</option>`);
        });
        if (vendedorId) {
          vendSelect.val(vendedorId);
        }
      });
    }

    // =========================================================================
    // CARREGAMENTO DE DADOS (PROPOSTAS EXISTENTES) - financeira/modal/seg/prod
    // =========================================================================
    function carregarFinanceiraModalSegProd() {
      if (!financeiraId) {
        console.log('[Financeira/Modal/Segm/Prod] Sem financeiraId (nova proposta).');
        return;
      }
      // Seta financeira
      $('#id_financeira').val(financeiraId);

      // Carrega modalidades
      fetchModalidades(financeiraId).then(modais => {
        $('#id_modalidade')
          .empty()
          .append('<option value="">Selecione a Modalidade...</option>');
        modais.forEach(m => {
          $('#id_modalidade').append(`<option value="${m.id}">${m.nome_modalidade}</option>`);
        });
        if (modalidadeId) {
          $('#id_modalidade').val(modalidadeId);
          return fetchSegmentos(financeiraId, modalidadeId);
        }
        return null;
      }).then(segmentos => {
        if (!segmentos) return;
        $('#id_segmento')
          .empty()
          .append('<option value="">Selecione o Segmento...</option>');
        segmentos.forEach(s => {
          $('#id_segmento').append(`<option value="${s.id}">${s.nome_segmento}</option>`);
        });
        if (segmentoId) {
          $('#id_segmento').val(segmentoId);
          return fetchProdutos(financeiraId, modalidadeId, segmentoId);
        }
        return null;
      }).then(produtos => {
        if (!produtos) return;
        $('#id_produto')
          .empty()
          .append('<option value="">Selecione o Produto...</option>');
        produtos.forEach(p => {
          $('#id_produto').append(`<option value="${p.id}">${p.nome_produto}</option>`);
        });
        if (produtoId) {
          $('#id_produto').val(produtoId);
        }
      });
    }

    // =========================================================================
    // MODAL PARA ADICIONAR NOVO VENDEDOR
    // =========================================================================
    $('#formNovoVendedor').on('submit', function(e) {
      e.preventDefault();
      let nomeVendedor    = $('#novo_vendedor_nome').val();
      let cpfVendedor     = $('#novo_vendedor_cpf').val();
      let celularVendedor = $('#novo_vendedor_celular').val();
      let emailVendedor   = $('#novo_vendedor_email').val();
      let chavePix        = $('#novo_vendedor_pix').val();
      let lojaId          = $('#id_loja').val();
      let csrfToken       = $('input[name="csrfmiddlewaretoken"]').val();
      
      if (!nomeVendedor || !cpfVendedor || !celularVendedor || !lojaId) {
        alert("Preencha os campos obrigatórios!");
        return;
      }
      
      fetch("/lojas/criar_vendedor/", {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({
          "nome_vendedor": nomeVendedor,
          "cpf_vendedor": cpfVendedor,
          "celular_vendedor": celularVendedor,
          "email_vendedor": emailVendedor,
          "chave_pix": chavePix,
          "loja": lojaId
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          let vendedorSelect = $('#id_vendedor');
          let newOption = $('<option></option>').val(data.vendedor_id).text(nomeVendedor);
          vendedorSelect.append(newOption).val(data.vendedor_id);
          $('#modalNovoVendedor').modal('hide');
          $('#formNovoVendedor')[0].reset();
        } else {
          alert("Erro ao cadastrar vendedor: " + data.error);
        }
      })
      .catch(error => {
        console.error("Erro ao cadastrar vendedor:", error);
        alert("Erro ao cadastrar vendedor.");
      });
    });

    // =========================================================================
    // INICIALIZAÇÃO
    // =========================================================================
    carregarOperadorLoja();
    carregarFinanceiraModalSegProd();
    aplicarMascaras();
    verificarStatusPagamento();  // <-- Chamamos a função para habilitar/desabilitar dt_pagamento
  });
</script>




{% endblock %}
